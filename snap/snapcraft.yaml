name: monophony # you probably want to 'snapcraft register <name>'
base: core22 # the base snap is the execution environment for this snap
version: '1.6.0' # just for humans, typically '1.2+git' or '1.3.2'
adopt-info: monophony
icon: icon.svg
grade: stable # must be 'stable' to release into candidate/stable channels
confinement: strict # use 'strict' once you have the right plugs and slots
compression: lzo

#package-repositories:
#  - type: apt
#    components: [main, multiverse, #restricted, universe]
#    suites: [kinetic, kinetic-backports, #kinetic-security, kinetic-updates]
#    key-id: #F6ECB3762474EDA9D21B7022871920D1991BC93C
#    url: #http://security.ubuntu.com/ubuntu
#environment:
  # WORKAROUND: Add python modules in Snap to search path
  #PYTHONPATH: ${SNAP}/lib/python3.10/site-packages:${SNAP}/usr/lib/python3/dist-packages

parts:
  cpython:
    source: https://github.com/python/cpython.git
    source-tag: v3.12.0a7
    plugin: make
  #libexpat:
  #  source: https://github.com/libexpat/libexpat.git
  #  source-tag: R_2_5_0
  #  source-subdir: expat
  #  plugin: cmake
  #  cmake-parameters:
  #    - -DCMAKE_INSTALL_PREFIX=/usr
  #  prime:
  #    - usr/lib/*/libexpat.so*
  nuitka:
    plugin: python
    source: https://github.com/Nuitka/Nuitka.git
    source-tag: 1.4.8
    source-type: git
    build-environment:
      # WORKAROUND: The python plugin is broken with gnome extension
      - PATH: ${CRAFT_PART_INSTALL}/bin:${PATH}
      - PYTHONPATH: ""
    python-packages:
      - requests
      - PyGObject
      - ordered-set
      - ytmusicapi
      - yt-dlp
      - lxml
      - MarkupSafe
      - appdirs
      - Jinja2
  ffmpeg:
    after: [nuitka]
    # WORKAROUND:
    # Build from source because the ffmpeg package installs libraries as dependencies
    # that conflict with the Gnome extension
    plugin: autotools
    source: https://ffmpeg.org/releases/ffmpeg-5.1.2.tar.xz
    source-checksum: sha256/619e706d662c8420859832ddc259cd4d4096a48a2ce1eefd052db9e440eef3dc
    autotools-configure-parameters:
      # WORKAROUND: Install to /usr instead of /usr/local because it's not in search paths
      - --prefix=/usr
      - --disable-debug
      - --disable-doc
      - --disable-static
      - --enable-gpl
      - --enable-shared
      - --disable-ffplay
      - --disable-devices
      - --enable-gnutls
      - --enable-libmp3lame
      - --enable-libvorbis
    build-packages:
      - nasm
      - libgnutls28-dev
      - libmp3lame-dev
      - libvorbis-dev
    stage-packages:
      - libmp3lame0
    stage:
      - -usr/include
  monophony:
    after: [ffmpeg, nuitka, libexpat]
    # See 'snapcraft plugins'
    plugin: make
    source: https://gitlab.com/zehkira/monophony.git
    source-tag: v$SNAPCRAFT_PROJECT_VERSION
    source-subdir: source
    source-type: git
    build-packages:
      - libgstreamer1.0-dev
      - gstreamer1.0-libav
      - gstreamer1.0-plugins-good
    stage-packages:
      - gstreamer1.0-libav
      - gstreamer1.0-plugins-good
    build-environment:
      - PATH: ${CRAFT_STAGE}/bin:${PATH}
      - LDFLAGS: "$LDFLAGS -L/$CRAFT_STAGE/usr/lib/x86_64-linux-gnu -lz -lexpat"
    parse-info: [usr/share/metainfo/io.gitlab.zehkira.Monophony.metainfo.xml]


apps:
  monophony:
    command: usr/bin/monophony
    desktop: usr/share/applications/io.gitlab.zehkira.Monophony.desktop
    extensions: [gnome]
    plugs:
      - home
    slots:
      - mpris
